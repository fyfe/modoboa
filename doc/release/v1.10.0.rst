Version 1.10.0
==============

Upgrade to Version 1.10.0
-------------------------
Version 1.10.0 upgrades `Django <https://docs.djangoproject.com/en/1.11/releases/>`
to version 1.11 which requires all installed plugins to be upgraded to the
following minimum versions.

+---------------------------+-----------------+
| Extension                 | Minimum Version |
+===========================+=================+
| modoboa-amavis            | 1.2.0           |
+---------------------------+-----------------+
| modoboa-contacts          | 0.5.0           |
+---------------------------+-----------------+
| modoboa-dmarc             | 1.1.0           |
+---------------------------+-----------------+
| modoboa-imap-migration    | 1.2.0           |
+---------------------------+-----------------+
| modoboa-pdfcredentials    | 1.3.0           |
+---------------------------+-----------------+
| modoboa-postfix-autoreply | 1.4.0           |
+---------------------------+-----------------+
| modoboa-radicale          | 1.2.0           |
+---------------------------+-----------------+
| modoboa-sievefilters      | 1.4.0           |
+---------------------------+-----------------+
| modoboa-stats             | 1.4.0           |
+---------------------------+-----------------+
| modoboa-webmail           | 1.4.0           |
+---------------------------+-----------------+

.. _step_01:
1. Upgrade modoboa

  .. sourcecode:: bash

    > pip install --upgrade <extension_name>==1.10.0

.. _step_02:
2. Upgrade installed extensions

  .. sourcecode:: bash

    # list installed extensions
    > pip freeze | grep "^modoboa-"
    # for each extension
    > pip install --upgrade <extension_name>\>=<minimum_version>

.. _step_03:
3. Make the following changes to :file:`settings.py`
  * Add `'modoboa.transport'` to `MODOBOA_APPS`:

    .. sourcecode:: python

      MODOBOA_APPS = (
       'modoboa',
       'modoboa.core',
       'modoboa.lib',
       'modoboa.admin',
       'modoboa.transport',
       'modoboa.relaydomains',
       'modoboa.limits',
       'modoboa.parameters',
      )

  * Replace the following line:

    .. sourcecode:: python

      MIDDLEWARE_CLASSES = (

    by:

    .. sourcecode:: python

      MIDDLEWARE = (

  * If you use the amavis plugin, make sure to include its configuration as
    follows:

    .. sourcecode:: python

      from modoboa_amavis import settings as modoboa_amavis_settings
      modoboa_amavis_settings.apply(globals())

.. _step_04:
4. Run database migrations and update static content:

  .. sourcecode:: bash

    > cd <modoboa_instance_dir>
    > python manage.py migrate
    > python manage.py collectstatic

.. _step_05:
5. Run Djangos deployment checks:

  .. sourcecode:: bash

    > cd <modoboa_instance_dir>
    > python manage.py check --deploy

  .. note::

    The `security.W001` warning can be ignored as this is handled by nginx.

.. _step_06:
6. Restart your web server

.. _step_07:
7. Update postfix map files as follows:

  .. sourcecode:: bash

    > rm -f <path>/modoboa-postfix-maps.chk
    > python manage.py generate_postfix_maps --force --destdir <path>

.. _step_08:
8. Modify postfix's configuration as follows:

  smtpd_sender_login_maps =
    <driver>:<path>/sql-sender-login-map.cf

  transport_maps =
    <driver>:<path>/sql-transport.cf
    <driver>:<path>/sql-spliteddomains-transport.cf
    # other map files...

  * Replace ``<driver>`` and ``<path>`` by your values.

  * If ``transport_maps`` contains ``sql-relaydomains-transport.cf``, remove it.

.. _step_09:
9. Reload postfix

.. _step_10:
10. Add the following cron job in order to generate DKIM keys:

  # Generate DKIM keys (they will belong to the user running this job)
  *       *       *       *       *       root    $PYTHON $INSTANCE/manage.py modo manage_dkim_keys


Changes
-------
...
